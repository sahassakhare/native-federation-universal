<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Native Federation Runtime Demo - Host</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    .nav {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 2px solid #eee;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.2s;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #content {
      min-height: 300px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-top: 20px;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
    .error {
      color: #dc3545;
      padding: 10px;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
    }
    .success {
      color: #155724;
      padding: 10px;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 4px;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸš€ Native Federation Runtime Demo - Host</h1>
    <p>This demonstrates real module federation using the Native Federation runtime.</p>
    
    <div class="nav">
      <button id="btn-home">Home</button>
      <button id="btn-load-app">Load Remote App</button>
      <button id="btn-load-component">Load Remote Component</button>
      <button id="btn-check-manifest">Check Manifest</button>
    </div>
    
    <div id="content">
      <h2>Welcome to the Host Application</h2>
      <p>Click the buttons above to load remote modules dynamically.</p>
    </div>
  </div>

  <!-- Import map for Native Federation runtime -->
  <script type="importmap">
  {
    "imports": {
      "@native-federation/runtime": "http://localhost:3000/runtime.js"
    }
  }
  </script>

  <!-- Federation manifest -->
  <script id="federation-manifest" type="application/json">
  {
    "name": "host",
    "remotes": {
      "mfe1": {
        "url": "http://localhost:4201",
        "entry": "http://localhost:4201/remoteEntry.js",
        "modules": {
          "./App": "http://localhost:4201/App.js",
          "./components/Dynamic": "http://localhost:4201/components/Dynamic.js"
        }
      }
    }
  }
  </script>

  <!-- Main application script -->
  <script type="module">
    // Simple federation runtime implementation
    class FederationRuntime {
      constructor(manifest) {
        this.manifest = manifest;
        this.loadedModules = new Map();
        console.log('[Runtime] Initialized with manifest:', manifest);
      }

      async loadRemoteModule(remoteName, modulePath) {
        const moduleKey = `${remoteName}:${modulePath}`;
        
        // Check cache
        if (this.loadedModules.has(moduleKey)) {
          console.log('[Runtime] Module from cache:', moduleKey);
          return this.loadedModules.get(moduleKey);
        }

        // Find remote configuration
        const remote = this.manifest.remotes[remoteName];
        if (!remote) {
          throw new Error(`Remote "${remoteName}" not found in manifest`);
        }

        // Get module URL
        const moduleUrl = remote.modules[modulePath];
        if (!moduleUrl) {
          throw new Error(`Module "${modulePath}" not found in remote "${remoteName}"`);
        }

        console.log('[Runtime] Loading module:', moduleKey, 'from', moduleUrl);

        try {
          // Dynamically import the module
          const module = await import(moduleUrl);
          this.loadedModules.set(moduleKey, module);
          console.log('[Runtime] Module loaded successfully:', moduleKey);
          return module;
        } catch (error) {
          console.error('[Runtime] Failed to load module:', error);
          throw error;
        }
      }
    }

    // Initialize runtime
    const manifestElement = document.getElementById('federation-manifest');
    const manifest = JSON.parse(manifestElement.textContent);
    const runtime = new FederationRuntime(manifest);
    
    // Make runtime globally available
    window.__NATIVE_FEDERATION_RUNTIME__ = runtime;

    // Helper function to update content
    function updateContent(html) {
      document.getElementById('content').innerHTML = html;
    }

    // Event handlers
    document.getElementById('btn-home').addEventListener('click', () => {
      updateContent(`
        <h2>Host Application</h2>
        <p>This is the host application running at <strong>http://localhost:3000</strong></p>
        <h3>Features:</h3>
        <ul>
          <li>âœ… ESM-based Module Federation</li>
          <li>âœ… Dynamic Remote Loading</li>
          <li>âœ… No Webpack Required</li>
          <li>âœ… Native Browser Support</li>
        </ul>
      `);
    });

    document.getElementById('btn-load-app').addEventListener('click', async () => {
      updateContent('<p class="loading">Loading remote application...</p>');
      
      try {
        const module = await runtime.loadRemoteModule('mfe1', './App');
        
        if (module.render) {
          updateContent(module.render());
        } else if (module.default) {
          updateContent(`
            <div class="success">
              <h3>Remote App Loaded!</h3>
              <pre>${JSON.stringify(module.default, null, 2)}</pre>
            </div>
          `);
        }
      } catch (error) {
        updateContent(`<div class="error">Error: ${error.message}</div>`);
      }
    });

    document.getElementById('btn-load-component').addEventListener('click', async () => {
      updateContent('<p class="loading">Loading remote component...</p>');
      
      try {
        const module = await runtime.loadRemoteModule('mfe1', './components/Dynamic');
        
        if (module.DynamicComponent) {
          const component = new module.DynamicComponent();
          const container = document.getElementById('content');
          container.innerHTML = '';
          container.appendChild(component.element);
        } else {
          updateContent(`<div class="error">Component not found in module</div>`);
        }
      } catch (error) {
        updateContent(`<div class="error">Error: ${error.message}</div>`);
      }
    });

    document.getElementById('btn-check-manifest').addEventListener('click', () => {
      updateContent(`
        <h2>Federation Manifest</h2>
        <pre>${JSON.stringify(manifest, null, 2)}</pre>
        <h3>Loaded Modules:</h3>
        <ul>
          ${Array.from(runtime.loadedModules.keys()).map(key => `<li>${key}</li>`).join('') || '<li>No modules loaded yet</li>'}
        </ul>
      `);
    });

    console.log('[Host] Application ready');
  </script>
</body>
</html>